---
title: 关于MySQL各类锁的总结
categories:
  - summary
tags:
  - mysql
abbrlink: 3d7cfa16
date: 2020-12-19 21:08:46
---

想要用好 MySQL，索引与锁是一个绕不开的话题。最近一直在维护老的业务系统，线上频繁报出数据库死锁的异常警告，为了排查以及规避死锁的问题，因此对 MySQL 的锁（Innodb引擎）做了一个比较深入学习，顺便加深自己对 MySQL 的理解程度。个人感觉 MySQL 中的锁非常的杂，官网对于锁的介绍也是和盘托出，并没有分门别类的罗列出来，下面分别从锁的模式与类型来总结，从这两个方面总结主要是依据“INNODB_LOCKS”中的“lock_mode”、“lock_type”两个字段考虑的。

<!--more-->

## 锁的模式

MySQL 中有锁的模式这个概念，在 Innodb 中锁的模式有共享锁（S锁）、排它锁（X锁）两大类。除了这两大类，还有一个意向锁的概念，意向锁在锁模式中有意向共享锁（IS锁）、意向排它锁（IX锁）两类，意向锁并不是一种真正的锁，它更像是一个标识。

### 共享锁（行锁）

对于同一个资源，大家都可以同时加上共享锁，可以理解成非独家的资源，大家都可以获取。但是共享锁与排它锁互斥，在 MySQL 中可以使用“lock in share mode”加共享锁。

### 排它锁（行锁）

排它锁与共享锁不兼容，因此只有一个事物可以获取指定资源的排它锁，在 MySQL 中可以使用“for update”加排它锁。

### 意向共享锁（表锁）

意向共享锁对应共享锁，一个作用在记录上，一个作用在表上。当外界想对某张表加排它锁时，意向共享锁用来告诉外界我的表中有数据持有共享锁，而不是去扫描表中的所有数据来判断是否可以执行加锁操作。

### 意向排它锁（表锁）

意向排它锁对应排它锁，同理意向共享锁，也是为了提升加锁的效率。

## 锁的算法

锁的模式侧重锁的意图，锁的类型更加偏重锁的范围，例如下面列举的这些锁都是跟锁住的数据区间有关系。

### 记录锁（行锁）

记录锁作用在精确匹配的唯一索引上，它与间隙锁最大的差别在于间隙锁锁住的是不存在的区间。

记录锁 SQL 示例：

条件：id 是唯一键，id = 1 的数据存在

```
select * from user where id = 1 for update;
```

### 间隙锁（行锁）

间隙锁作用在一个没有记录的区间，所以上界、下界都是开区间。间隙锁存在的目的主要是为了阻塞插入操作，因为它可以解决幻读的问题。插入的间隙锁之间是兼容的，不会出现阻塞，查询之间的间隙锁也是兼容的，但是插入和查询条件下的间隙锁是不兼容的，会阻塞对方。

间隙锁阻塞示例：

条件：id = 6 的数据不存在，id = 7 的数据也不存在

事物一

```
select * from user where id = 6 for update;
```

事物二

```
insert into user(id) values(7);
```

需要注意的是 RC 的事物隔离级别下是不存在间隙锁的，因为 RC 隔离级别下是存在幻读的问题的。

### 临键锁（行锁）

临键锁是由记录锁与间隙锁组成的（区间为左开右闭），因为我们在查找数据的时候可能存在部分数据存在，部分不存在的问题，所以记录锁与间隙锁可以理解成特殊场景下的临键锁。Innodb 引擎行锁默认采用的就是临键锁的算法，但是临键锁有一个特殊的地方就是它会锁住最后一条记录的左开右闭的区间。

临键锁区间计算：
条件：id 存在的数据有1，2，5，7，10

```
select * from user where id > 3 and id < 9 for update;
```
这条 SQL 锁住的区间有(2,5],(5,7],(7,10]，最后一条记录的左开右闭的区间是（7，10]。

```
select * from user where id > 3 and id <= 10 for update;
```
这条 SQL 锁住的区间有(2,5],(5,7],(7,10],(10,+∞)，最后一条记录的左开右闭的区间是（(10,+∞)。

## 查看锁的命令

查看当前数据库所有事物的状态：

```
show engine innodb status;
```

查看当前数据库锁的记录

```
select * from information_schema.INNODB_LOCKS;
```

